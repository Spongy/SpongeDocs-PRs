
<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Implement Your Own AITasks &mdash; Sponge 7.2.0 documentation</title>

    <link rel="shortcut icon" href="../../_static/favicon.ico"/>




    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

    <link rel="stylesheet" href="../../_static/spongedocs.css" type="text/css" />

        <link rel="index" title="Index"
              href="../../genindex.html"/>        <link rel="search" title="Search" href="../../search.html"/>    <link rel="top" title="Sponge 7.2.0 documentation" href="../../index.html"/>        <link rel="up" title="Entities" href="index.html"/>        <link rel="next" title="Items" href="../items/index.html"/>        <link rel="prev" title="Entity AI" href="ai.html"/>
    <!-- Google Analytics -->
    <script>
        (function(S,p,o,n,g,i,e){S['GoogleAnalyticsObject']=g;S[g]=S[g]||function(){
        (S[g].q=S[g].q||[]).push(arguments)},S[g].l=1*new Date();i=p.createElement(o),
        e=p.getElementsByTagName(o)[0];i.async=1;i.src=n;e.parentNode.insertBefore(i,e)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-59476017-2', 'auto');
        ga('send', 'pageview');
    </script>

  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
    <div id="sp-logo-container" class="page-scroll">
        <a class="logo" href="../../index.html">
            <img src="../../_static/spongie-mark-dark.svg">
            <span>Sponge</span>
            <i class="fa fa-fw fa-chevron-down"></i>
        </a>
        <div id="sp-logo-menu">
            <ul id="sp-logo-dropdown">
                <li><a href="https://www.spongepowered.org"><i class="fa-fw fa fa-home"></i>Homepage</a></li>
                <li><a href="https://forums.spongepowered.org"><i class="fa-fw fa fa-comments"></i>Forums</a></li>
                <li><a href="https://github.com/SpongePowered"><i class="fa-fw fa fa-code"></i>Code</a></li>
                <li class="active"><a href="https://docs.spongepowered.org"><i class="fa-fw fa fa-book"></i>Docs</a></li>
                <li><a href="https://jd.spongepowered.org"><i class="fa-fw fa fa-graduation-cap"></i>Javadocs</a></li>
                <li><a href="https://forums.spongepowered.org/c/plugins/plugin-releases"><i class="fa-fw fa fa-plug"></i>Plugins</a></li>
                <li><a href="https://ore.spongepowered.org"><img src="../../_static/ore.svg" alt="" class="fa-fw fa ore-logo">Ore <sup>Beta</sup></a></li>
                <li><a href="https://www.spongepowered.org/downloads"><i class="fa-fw fa fa-download"></i>Downloads</a></li>
                <li><a href="https://www.spongepowered.org/chat"><i class="fa-fw fa fa-comment"></i>Chat</a></li>
            </ul>
        </div>
    </div>

<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../server/index.html">Creating a Server</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../versions/index.html">Versioning Policy</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../preparing/index.html">Preparing for Development</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Creating a Plugin</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../api-versions.html">API-Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../buildsystem.html">Build Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workspace/index.html">Setting Up Your Workspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project/index.html">Setting Up Your Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugin-identifier.html">Plugin Identifiers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugin-class.html">Main Plugin Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lifecycle.html">Plugin Lifecycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../injection.html">Dependency Injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../practices/index.html">Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../optional/index.html">Optionals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging.html">Logging and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../text/index.html">Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="../commands/index.html">Plugin Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../event/index.html">Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration/index.html">Configuring Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../assets.html">The Asset API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/index.html">The Data API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blocks/index.html">Blocks</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Entities</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="spawning.html">Spawning an Entity</a></li>
<li class="toctree-l3"><a class="reference internal" href="modifying.html">Modifying an Entity</a></li>
<li class="toctree-l3"><a class="reference internal" href="ai.html">Entity AI</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Implement Your Own AITasks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../items/index.html">Items</a></li>
<li class="toctree-l2"><a class="reference internal" href="../trade-offers.html">Trade-Offers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../effects.html">Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scheduler.html">Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services.html">Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../database.html">Databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../permissions.html">Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bans.html">Bans</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics.html">Metrics Collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bookview.html">Book Views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../economy/index.html">Economy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wgen/index.html">World Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../manager.html">Plugin Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../game-profile-manager.html">Game Profile Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../offline-userplayer-data.html">Offline Player Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tab-lists.html">Tab Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugin-meta.html">Plugin Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ray-tracing.html">Ray Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debugging.html">Plugin Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/index.html">Implementation-dependent Plugins</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ore/index.html">Ore Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing to Sponge</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About the Sponge Project</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Sponge</a>
      </nav>


      <div class="wy-nav-content">
        <div class="rst-content">

 

<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
          <li><a href="../index.html">Creating a Plugin</a> &raquo;</li>
          <li><a href="index.html">Entities</a> &raquo;</li>
    <li>Implement Your Own AITasks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/plugin/entities/custom-ai.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
  <div class="section" id="implement-your-own-aitasks">
<h1>Implement Your Own AITasks<a class="headerlink" href="#implement-your-own-aitasks" title="Permalink to this headline">¶</a></h1>
<p>Before we start implementing our own <a class="reference external" href="https://jd.spongepowered.org/7.2.0/org/spongepowered/api/entity/ai/task/AITask.html">AITask</a> we have to make sure our workspace is properly configured. Please
follow the instructions in <a class="reference internal" href="../internals/mcp-setup.html"><span class="doc">Using MCP in Plugins</span></a>.</p>
<p>Here is a list of imports we will use while implementing the <code class="docutils literal notranslate"><span class="pre">AITask</span></code>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.Comparator</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.Predicate</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.spongepowered.api.GameRegistry</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.spongepowered.api.entity.Entity</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.spongepowered.api.entity.ai.task.AITask</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.spongepowered.api.entity.ai.task.AITaskType</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.spongepowered.api.entity.ai.task.AbstractAITask</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.spongepowered.api.entity.living.Agent</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.flowpowered.math.vector.Vector3d</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.google.common.base.Preconditions</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">net.minecraft.entity.EntityLiving</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">net.minecraft.entity.ai.EntityAIBase</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">net.minecraft.pathfinding.PathNavigate</span><span class="p">;</span>
</pre></div>
</div>
<p>To simplify the implementation, we use the following constants. They are optional and could be easily replaced by dynamic
fields set via a constructor.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">MOVEMENT_SPEED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">APPROACH_DISTANCE_SQUARED</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="n">MAX_DISTANCE_SQUARED</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">20</span><span class="p">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="n">EXECUTION_CHANCE</span> <span class="o">=</span> <span class="mf">0.2F</span><span class="p">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MUTEX_FLAG_MOVE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Minecraft bit flag</span>
</pre></div>
</div>
<p>If you want to implement your own <code class="docutils literal notranslate"><span class="pre">AITask</span></code> then you must extend <a class="reference external" href="https://jd.spongepowered.org/7.2.0/org/spongepowered/api/entity/ai/task/AbstractAITask.html">AbstractAITask</a> with your task. The
following example shows an example implementation of such a custom AITask. Also, we need to generate a new
<a class="reference external" href="https://jd.spongepowered.org/7.2.0/org/spongepowered/api/entity/ai/task/AITaskType.html">AITaskType</a> for our <code class="docutils literal notranslate"><span class="pre">AITask</span></code>. To avoid spreading the logic everywhere we simply create a static field and a
<code class="docutils literal notranslate"><span class="pre">register</span></code> method for it in the class itself as shown by the following code example:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreepyCompanionAITask</span> <span class="kd">extends</span> <span class="n">AbstractAITask</span><span class="o">&lt;</span><span class="n">Agent</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">AITaskType</span> <span class="n">TYPE</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">register</span><span class="p">(</span><span class="kd">final</span> <span class="n">Object</span> <span class="n">plugin</span><span class="p">,</span> <span class="kd">final</span> <span class="n">GameRegistry</span> <span class="n">gameRegistry</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">TYPE</span> <span class="o">=</span> <span class="n">gameRegistry</span>
                <span class="p">.</span><span class="na">registerAITaskType</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="s">&quot;creepy_companion&quot;</span><span class="p">,</span> <span class="s">&quot;CreepyCompanion&quot;</span><span class="p">,</span> <span class="n">CreepyCompanionAITask</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="o">[</span><span class="p">...</span><span class="o">]</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Of course, we still need to call that method from our main class, but that can be easily done like this from our plugin
main class:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Listener</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onInitialize</span><span class="p">(</span><span class="kd">final</span> <span class="n">GameInitializationEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CreepyCompanionAITask</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After that we can finally start implementing the AITask. For this we need to implement a total of seven methods and a
constructor:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">CreepyCompanionAITask(...)</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">boolean</span> <span class="pre">canRunConcurrentWith(AITask&lt;Agent&gt;)</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">boolean</span> <span class="pre">canBeInterrupted()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">boolean</span> <span class="pre">shouldUpdate()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">start()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">boolean</span> <span class="pre">continueUpdating()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">update()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">reset()</span></code></li>
</ul>
<p>The following image roughly describes the method execution order:</p>
<img alt="The method execution order of the ai task" class="align-center" src="../../_images/ai-execution-order.png" />
<p>We need the constructor to set any parameters we want our <code class="docutils literal notranslate"><span class="pre">AITask</span></code> to have and configure some base options for it. In
this case it’s setting the <code class="docutils literal notranslate"><span class="pre">AITaskType</span></code> and configuring the mutex bits, along with an <code class="docutils literal notranslate"><span class="pre">entityFilter</span></code>
<a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html">Predicate</a> that we will use later on.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span> <span class="n">entityFilter</span><span class="p">;</span>

<span class="kd">private</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span> <span class="n">optTarget</span><span class="p">;</span>

<span class="kd">public</span> <span class="nf">CreepyCompanionAITask</span><span class="p">(</span><span class="kd">final</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">&gt;</span> <span class="n">entityFilter</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">super</span><span class="p">(</span><span class="n">TYPE</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="na">entityFilter</span> <span class="o">=</span> <span class="n">Preconditions</span><span class="p">.</span><span class="na">checkNotNull</span><span class="p">(</span><span class="n">entityFilter</span><span class="p">);</span>
    <span class="p">((</span><span class="n">EntityAIBase</span><span class="p">)</span> <span class="p">(</span><span class="n">Object</span><span class="p">)</span> <span class="k">this</span><span class="p">).</span><span class="na">setMutexBits</span><span class="p">(</span><span class="n">MUTEX_FLAG_MOVE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Unfortunately, we have to resort to dirty casts to plain Minecraft classes. This is also the reason we have to setup our
workspace with MCP mappings.</p>
<p>After that we continue with the first set of methods: <code class="docutils literal notranslate"><span class="pre">canRunConcurrentWith</span></code> and <code class="docutils literal notranslate"><span class="pre">canBeInterrupted</span></code>. They are very
easy to implement. For the first one we are going to rely on the default Minecraft logic, but this once again
requires dirty casts. For the second one we just have to consider whether it can be interrupted or needs to complete
first.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">canRunConcurrentWith</span><span class="p">(</span><span class="kd">final</span> <span class="n">AITask</span><span class="o">&lt;</span><span class="n">Agent</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(((</span><span class="n">EntityAIBase</span><span class="p">)</span> <span class="p">(</span><span class="n">Object</span><span class="p">)</span> <span class="k">this</span><span class="p">).</span><span class="na">getMutexBits</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">EntityAIBase</span><span class="p">)</span> <span class="n">other</span><span class="p">).</span><span class="na">getMutexBits</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">canBeInterrupted</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With this we have all we need to actually put some custom logic in our <code class="docutils literal notranslate"><span class="pre">AITask</span></code>. Namely the logic when to start and
what to do in that case. We start with the check whether the task should be executed. This is usually done in two steps:</p>
<ul class="simple">
<li>Checking a random execution chance</li>
<li>Searching for a suitable target</li>
</ul>
<p>The actual execution is then just doing the desired thing with the target we found.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">shouldUpdate</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">final</span> <span class="n">Agent</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">getOwner</span><span class="p">().</span><span class="na">get</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="na">getRandom</span><span class="p">().</span><span class="na">nextFloat</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">EXECUTION_CHANCE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">final</span> <span class="n">Vector3d</span> <span class="n">position</span> <span class="o">=</span> <span class="n">getPositionOf</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="na">optTarget</span> <span class="o">=</span> <span class="n">owner</span><span class="p">.</span><span class="na">getWorld</span><span class="p">()</span>
            <span class="p">.</span><span class="na">getEntities</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
            <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">entityFilter</span><span class="p">)</span>
            <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">getPositionOf</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="na">distanceSquared</span><span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_DISTANCE_SQUARED</span><span class="p">)</span>
            <span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">Comparator</span><span class="p">.</span><span class="na">comparingDouble</span><span class="p">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">getPositionOf</span><span class="p">(</span><span class="n">e</span><span class="p">).</span><span class="na">distanceSquared</span><span class="p">(</span><span class="n">position</span><span class="p">)));</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="na">optTarget</span><span class="p">.</span><span class="na">isPresent</span><span class="p">();</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">getNavigator</span><span class="p">().</span><span class="na">tryMoveToEntityLiving</span><span class="p">((</span><span class="n">net</span><span class="p">.</span><span class="na">minecraft</span><span class="p">.</span><span class="na">entity</span><span class="p">.</span><span class="na">Entity</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="na">optTarget</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span> <span class="n">MOVEMENT_SPEED</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The owner’s <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/Random.html">Random</a> is usually a good source of randomness in those tasks, but any other <code class="docutils literal notranslate"><span class="pre">Random</span></code> would work
as well. The sole reason the <a class="reference external" href="https://jd.spongepowered.org/7.2.0/org/spongepowered/api/entity/Entity.html">Entity</a> has a random is to avoid having a <code class="docutils literal notranslate"><span class="pre">Random</span></code> in every class that
interacts with the entity.</p>
<p>The search for the target is pretty straight forward. First, we get all entities from the world the entity is currently
in and then we filter that list using the <code class="docutils literal notranslate"><span class="pre">entityFilter</span></code> <code class="docutils literal notranslate"><span class="pre">Predicate</span></code> that we set in the constructor. After that we
remove all entities that are too far away. That is 20 blocks, but you can increase this distance.
Please keep in mind that by increasing the range you also increase the computation time needed for path-finding.</p>
<p>After we have found our target we just have to tell the entity move towards it. The speed is a very important factor
for this. If the speed is too fast, then the entity might well accidentally miss the target and end up running back
and forth forever (so make sure that you calculate your acceptance criteria appropriately). If the speed is too slow,
then the entity will barely move (which looks somewhat strange and makes tasks such as follow X ridiculous).</p>
<p>The above code contains some method calls that have been added to increase the code readability; the following code
block shows those helper methods:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">Vector3d</span> <span class="nf">getPositionOf</span><span class="p">(</span><span class="kd">final</span> <span class="n">Entity</span> <span class="n">entity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">entity</span><span class="p">.</span><span class="na">getLocation</span><span class="p">().</span><span class="na">getPosition</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="n">PathNavigate</span> <span class="nf">getNavigator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">EntityLiving</span><span class="p">)</span> <span class="p">(</span><span class="n">getOwner</span><span class="p">().</span><span class="na">get</span><span class="p">())).</span><span class="na">getNavigator</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first method just calls a few methods in one go, the other gets the <code class="docutils literal notranslate"><span class="pre">PathNavigate</span></code> or movement controller from the
entity, which requires casting to Minecraft classes.</p>
<p>The last part we have to implement is the check whether the task should continue running and what needs to be done for
that.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">continueUpdating</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getNavigator</span><span class="p">().</span><span class="na">noPath</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="na">optTarget</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">final</span> <span class="n">Entity</span> <span class="n">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">optTarget</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">getPositionOf</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="na">distanceSquared</span><span class="p">(</span><span class="n">getPositionOf</span><span class="p">(</span><span class="n">getOwner</span><span class="p">().</span><span class="na">get</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="n">APPROACH_DISTANCE_SQUARED</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">reset</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">getNavigator</span><span class="p">().</span><span class="na">clearPath</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="na">optTarget</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For our <code class="docutils literal notranslate"><span class="pre">AITask</span></code> this is very easy. First, we check whether the entity lost its path and then whether the entity is
already close enough. If we return <code class="docutils literal notranslate"><span class="pre">false</span></code>, then Minecraft will invoke the <code class="docutils literal notranslate"><span class="pre">reset()</span></code> method next. There we should
perform some cleanup. In particular, the reference to the entity should be cleaned up, because otherwise we risk a
memory leak. If we return <code class="docutils literal notranslate"><span class="pre">true</span></code>, then Minecraft will invoke <code class="docutils literal notranslate"><span class="pre">update()</span></code>, which does nothing in our case because the
movement controller works independently from the AI and the entity will continue walking towards the target.</p>
<p>That’s all there is to writing custom <code class="docutils literal notranslate"><span class="pre">AITask</span></code>s. Now we can actually use it inside of an <code class="docutils literal notranslate"><span class="pre">Entity</span></code>, and the
“Adding Additional AITasks” chapter on the <a class="reference internal" href="ai.html"><span class="doc">Entity AI</span></a> page explains how to do that.</p>
<p>But why did we call this task <code class="docutils literal notranslate"><span class="pre">CreepyCompanionAITask</span></code>? There is a simple solution to that. When checking whether the
<code class="docutils literal notranslate"><span class="pre">AITask</span></code> should be executed, we don’t check whether the entity is already close enough, thus it will move a tiny bit
towards the target each time. The next step in creepiness would probably be that the entity only does this if the
target is not looking. Imagine a creeper slowly approaching from your back.</p>
</div>

           </div>
          </div>
<footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../items/index.html" class="btn btn-neutral float-right" title="Items" accesskey="n" rel="next">Next <span class="fa fa-angle-right"></span></a>
        <a href="ai.html" class="btn btn-neutral" title="Entity AI" accesskey="p" rel="prev"><span class="fa fa-angle-left"></span> Previous</a>
    </div>

    <hr/>

    <section id="license-footer">
        <p>Except where otherwise noted,
            <a xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" property="dct:title" rel="cc:attributionURL" href="https://github.com/SpongePowered/SpongeDocs">SpongeDocs</a>
            is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
        </p>
        <a id="license-icons" rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/" title="CC-BY-SA" aria-hidden="true">cba</a>
    </section>
</footer>        </div>
      </div>

    </section>

  </div>


<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <i class="fa fa-book"> <span>SpongeDocs</span></i>
        v: 7.2.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div id="versions" class="rst-other-versions">




    </div>
</div>

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'7.2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>      <script type="text/javascript" src="../../_static/jquery.js"></script>      <script type="text/javascript" src="../../_static/underscore.js"></script>      <script type="text/javascript" src="../../_static/doctools.js"></script>      <script type="text/javascript" src="../../_static/language_data.js"></script>      <script type="text/javascript" src="../../_static/spongedocs.js"></script>

    <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
 
</body>
</html>